---
name: CI Workflow


on:
  pull_request:
    branches:
      - '**'

concurrency:
  group: ${{ github.ref }}-ci-workflow

jobs:
  # build:
  #   runs-on: ubuntu-latest
  #   continue-on-error: false
  #   timeout-minutes: 10
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: "18"
  #         cache: 'npm'
  #         cache-dependency-path: frontend/package-lock.json

  #     # - name: Cache node modules
  #     #   uses: actions/cache@v3
  #     #   with:
  #     #     path: |
  #     #       frontend
  #     #     key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

  #     - name: Install Dependencies
  #       run: |
  #         cd frontend
  #         npm ci

  #     - name: Build code
  #       run: |
  #         cd frontend
  #         npm run build

  create-testing-branch:
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 
      - name: Create Testing Branch
        run: |
          # Define the testing branch name
          testing_branch="testing-${GITHUB_REF##*/}"
          
          # Check if the testing branch already exists
          git fetch origin "refs/heads/${testing_branch}" || git checkout -b "${testing_branch}"
          git push origin "${testing_branch}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    runs-on: ubuntu-latest
    continue-on-error: false
    timeout-minutes: 15
    needs: create-testing-branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install Dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: |
            frontend
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: Start Server and Run Tests
        run: |
          cd frontend
          npm run test
      
      - name: Merge Branch into Testing Branch
        run: |
          git fetch origin "refs/heads/${{ github.ref }}" --depth=1
          git checkout -b pr-branch "${{ github.sha }}"
          git merge --no-ff "refs/remotes/origin/${{ github.ref }}" --no-edit
          git push origin pr-branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete Testing Branch
        run: |
          # Define the testing branch name
          testing_branch="testing-${GITHUB_REF##*/}"
          
          # Delete the testing branch
          git push origin --delete "${testing_branch}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
